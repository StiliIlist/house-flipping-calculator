let debugMode = false;

function toggleDebug() {
    debugMode = !debugMode;
    const debugContent = document.getElementById('debugContent');
    debugContent.style.display = debugMode ? 'block' : 'none';
    if (debugMode) calculateAll();
}

function validateInput(id, value, min = 0, max = Infinity, label = '') {
    const input = document.getElementById(id);
    const errorEl = document.getElementById(id + '-error');
    let isValid = true;
    let errorMsg = '';

    // Reset styles
    input.classList.remove('error');
    if (errorEl) { // Check if errorEl exists (e.g., for display-only fields)
        errorEl.style.display = 'none';
    }

    if (isNaN(value) || value === null || value === undefined) {
        errorMsg = `${label} must be a valid number`;
        isValid = false;
    } else if (value < min) {
        errorMsg = `${label} cannot be less than ${min}`;
        isValid = false;
    } else if (value > max) {
        errorMsg = `${label} cannot be greater than ${max}`;
        isValid = false;
    }

    if (!isValid) {
        input.classList.add('error');
        if (errorEl) {
            errorEl.textContent = errorMsg;
            errorEl.style.display = 'block';
        }
    }

    return isValid;
}

function formatCurrency(amount) {
    if (isNaN(amount) || amount === null || amount === undefined) {
        return '$0';
    }
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function safeParseFloat(value, fallback = 0) {
    const parsed = parseFloat(value);
    return isNaN(parsed) ? fallback : parsed;
}

function calculateAll() {
    try {
        // Get all input values with validation
        const purchasePrice = safeParseFloat(document.getElementById('purchasePrice').value);
        const closingCosts = safeParseFloat(document.getElementById('closingCosts').value);
        const inspectionCosts = safeParseFloat(document.getElementById('inspectionCosts').value);
        const realtorCommission = safeParseFloat(document.getElementById('realtorCommission').value);
        const downPaymentPercent = safeParseFloat(document.getElementById('downPaymentPercent').value); // New input

        const kitchenBath = safeParseFloat(document.getElementById('kitchenBath').value);
        const flooring = safeParseFloat(document.getElementById('flooring').value);
        const painting = safeParseFloat(document.getElementById('painting').value);
        const roofHVAC = safeParseFloat(document.getElementById('roofHVAC').value);
        const otherReno = safeParseFloat(document.getElementById('otherReno').value);
        const contingency = safeParseFloat(document.getElementById('contingency').value);

        const monthsToComplete = safeParseFloat(document.getElementById('monthsToComplete').value, 1);
        const interestRate = safeParseFloat(document.getElementById('interestRate').value);
        const monthlyInsurance = safeParseFloat(document.getElementById('monthlyInsurance').value);
        const monthlyTaxes = safeParseFloat(document.getElementById('monthlyTaxes').value);
        const monthlyUtilities = safeParseFloat(document.getElementById('monthlyUtilities').value);

        const salePrice = safeParseFloat(document.getElementById('salePrice').value);
        const sellingCommission = safeParseFloat(document.getElementById('sellingCommission').value);
        const sellingClosingCosts = safeParseFloat(document.getElementById('sellingClosingCosts').value);
        const stagingCosts = safeParseFloat(document.getElementById('stagingCosts').value);

        // Validate inputs
        let allValid = true;
        allValid &= validateInput('purchasePrice', purchasePrice, 1000, 10000000, 'Purchase Price');
        allValid &= validateInput('realtorCommission', realtorCommission, 0, 5, 'Buyer Agent Fee');
        allValid &= validateInput('downPaymentPercent', downPaymentPercent, 0, 100, 'Down Payment Percentage'); // Validate new input
        allValid &= validateInput('contingency', contingency, 0, 50, 'Contingency');
        allValid &= validateInput('monthsToComplete', monthsToComplete, 0.5, 60, 'Project Timeline');
        allValid &= validateInput('interestRate', interestRate, 0, 30, 'Interest Rate');
        allValid &= validateInput('salePrice', salePrice, 1000, 20000000, 'Sale Price');
        allValid &= validateInput('sellingCommission', sellingCommission, 0, 15, 'Selling Commission');

        // Calculations with safety checks
        const buyCommission = purchasePrice * (realtorCommission / 100);
        const acquisitionTotal = purchasePrice + closingCosts + inspectionCosts + buyCommission;

        // New calculations for purchase price breakdown
        const downPaymentAmount = purchasePrice * (downPaymentPercent / 100);
        const mortgageAmount = purchasePrice - downPaymentAmount;

        // Automatically update the loanAmount input based on the calculated mortgage
        // This ensures consistency between the two fields
        document.getElementById('loanAmount').value = mortgageAmount.toFixed(0);
        const loanAmount = mortgageAmount; // Use the calculated mortgage amount for further calculations

        // Cash needed for purchase: down payment + closing costs + inspection costs + buyer agent fee
        const cashNeededForPurchase = downPaymentAmount + closingCosts + inspectionCosts + buyCommission;


        const baseRenovation = kitchenBath + flooring + painting + roofHVAC + otherReno;
        const contingencyAmount = baseRenovation * (contingency / 100);
        const renovationTotal = baseRenovation + contingencyAmount;

        const monthlyInterest = loanAmount > 0 ? (loanAmount * (interestRate / 100)) / 12 : 0;
        const monthlyCarrying = monthlyInterest + monthlyInsurance + monthlyTaxes + monthlyUtilities;
        const carryingTotal = monthlyCarrying * monthsToComplete;

        const sellCommission = salePrice * (sellingCommission / 100);
        const sellingTotal = sellCommission + sellingClosingCosts + stagingCosts;

        const totalInvestment = acquisitionTotal + renovationTotal + carryingTotal;
        const netProceeds = salePrice - sellingTotal;
        const totalProfit = netProceeds - totalInvestment;
        const roi = totalInvestment > 0 ? (totalProfit / totalInvestment) * 100 : 0;
        const profitPerMonth = monthsToComplete > 0 ? totalProfit / monthsToComplete : 0;
        const breakEven = totalInvestment + sellingTotal;

        // Update display
        document.getElementById('acquisitionTotal').textContent = formatCurrency(acquisitionTotal);
        document.getElementById('renovationTotal').textContent = formatCurrency(renovationTotal);
        document.getElementById('carryingTotal').textContent = formatCurrency(carryingTotal);
        document.getElementById('sellingTotal').textContent = formatCurrency(sellingTotal);
        document.getElementById('totalCost').textContent = formatCurrency(totalInvestment);

        document.getElementById('totalInvestment').textContent = formatCurrency(totalInvestment);
        document.getElementById('netProceeds').textContent = formatCurrency(netProceeds);
        document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
        document.getElementById('roi').textContent = roi.toFixed(1) + '%';
        document.getElementById('profitPerMonth').textContent = formatCurrency(profitPerMonth);
        document.getElementById('breakEven').textContent = formatCurrency(breakEven);

        // Display the new breakdown values
        document.getElementById('cashNeededPurchaseDisplay').value = formatCurrency(cashNeededForPurchase); // Update display for cash needed

        // Update results section styling based on profit
        const resultsSection = document.getElementById('resultsSection');
        if (totalProfit > 0) {
            resultsSection.className = 'results profit-positive';
        } else {
            resultsSection.className = 'results profit-negative';
        }

        // Add to Project Breakdown Timeline
        let timelineDiv = document.querySelector('.timeline');
        let existingBreakdown = document.getElementById('purchaseBreakdown');
        if (!existingBreakdown) {
            existingBreakdown = document.createElement('div');
            existingBreakdown.id = 'purchaseBreakdown';
            timelineDiv.insertBefore(existingBreakdown, timelineDiv.children[1]); // Insert after the first item
        }
        existingBreakdown.innerHTML = `
            <h4>Financing Breakdown:</h4>
            <div class="timeline-item">
                <span>Down Payment:</span>
                <span id="downPaymentAmount">$0</span>
            </div>
            <div class="timeline-item">
                <span>Mortgage Amount:</span>
                <span id="mortgageAmount">$0</span>
            </div>
            <div class="timeline-item" style="font-weight: bold; border-top: 1px solid #bdc3c7; padding-top: 5px;">
                <span>Cash to Close (Purchase):</span>
                <span id="cashToClosePurchase">$0</span>
            </div>
        `;
        document.getElementById('downPaymentAmount').textContent = formatCurrency(downPaymentAmount);
        document.getElementById('mortgageAmount').textContent = formatCurrency(mortgageAmount);
        document.getElementById('cashToClosePurchase').textContent = formatCurrency(cashNeededForPurchase);


        // Debug output
        if (debugMode) {
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.innerHTML = `
                <div>Purchase Price: ${formatCurrency(purchasePrice)}</div>
                <div>Down Payment Percent: ${downPaymentPercent}%</div>
                <div>Down Payment Amount: ${formatCurrency(downPaymentAmount)}</div>
                <div>Mortgage Amount: ${formatCurrency(mortgageAmount)}</div>
                <div>Cash Needed for Purchase: ${formatCurrency(cashNeededForPurchase)}</div>
                <div>Buy Commission: ${formatCurrency(buyCommission)}</div>
                <div>Acquisition Total: ${formatCurrency(acquisitionTotal)}</div>
                <div>Base Renovation: ${formatCurrency(baseRenovation)}</div>
                <div>Contingency Amount: ${formatCurrency(contingencyAmount)}</div>
                <div>Monthly Interest: ${formatCurrency(monthlyInterest)}</div>
                <div>Monthly Carrying: ${formatCurrency(monthlyCarrying)}</div>
                <div>Sell Commission: ${formatCurrency(sellCommission)}</div>
                <div>Net Proceeds: ${formatCurrency(netProceeds)}</div>
                <div>Total Investment: ${formatCurrency(totalInvestment)}</div>
                <div>Total Profit: ${formatCurrency(totalProfit)}</div>
                <div>ROI: ${roi.toFixed(2)}%</div>
                <div>Break Even: ${formatCurrency(breakEven)}</div>
                <div>All Inputs Valid: ${allValid}</div>
            `;
        }

    } catch (error) {
        console.error('Calculation error:', error);
        if (debugMode) {
            document.getElementById('debugOutput').innerHTML = `<div style="color: #e74c3c;">Error: ${error.message}</div>`;
        }
    }
}

// Add event listeners to all inputs
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input[type="number"]');
    inputs.forEach(input => {
        input.addEventListener('input', calculateAll);
        input.addEventListener('blur', calculateAll); // Recalculate on focus loss
    });

    // Initial calculation
    calculateAll();
});
